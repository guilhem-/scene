---
# Scene Performance Manager - Full Deployment Playbook
# Usage: ansible-playbook playbooks/deploy.yml --ask-vault-pass

- name: Provision AWS Infrastructure
  hosts: localhost
  connection: local
  gather_facts: false
  become: no
  vars_files:
    - ../vars/main.yml
    - ../vars/secrets.yml

  tasks:
    - name: Create security group
      ansible.builtin.include_role:
        name: security_group

    - name: Launch EC2 instance
      amazon.aws.ec2_instance:
        name: "scene_server"
        key_name: "{{ ec2_key_name }}"
        instance_type: "{{ ec2_instance_type }}"
        image_id: "{{ ec2_ami }}"
        region: "{{ aws_region }}"
        vpc_subnet_id: "{{ subnet_id }}"
        security_group: "{{ sg_id }}"
        network_interfaces:
          - assign_public_ip: true
            device_index: 0
        volumes:
          - device_name: /dev/sda1
            ebs:
              volume_size: "{{ ec2_volume_size | default(20) }}"
              delete_on_termination: true
              volume_type: gp3
        tags:
          Name: scene_server
          Project: scene
        wait: yes
        state: running
      register: ec2

    - name: Display EC2 instance info
      ansible.builtin.debug:
        msg:
          - "Instance ID: {{ ec2.instances[0].instance_id }}"
          - "Public IP: {{ ec2.instances[0].public_ip_address }}"

    - name: Set EC2 public IP fact
      ansible.builtin.set_fact:
        ec2_public_ip: "{{ ec2.instances[0].public_ip_address }}"

    - name: Add new instance to inventory
      ansible.builtin.add_host:
        hostname: "{{ ec2.instances[0].public_ip_address }}"
        groupname: scene_servers
        ansible_user: ubuntu
        ansible_ssh_private_key_file: "{{ ansible_ssh_private_key_file }}"

    - name: Wait for SSH to be available
      ansible.builtin.wait_for:
        host: "{{ ec2.instances[0].public_ip_address }}"
        port: 22
        delay: 10
        timeout: 300
        state: started

    - name: Configure Route53 DNS
      ansible.builtin.include_role:
        name: route53
      when: domain_name | default('') and route53_zone_id | default('')

- name: Configure Server
  hosts: scene_servers
  become: yes
  gather_facts: yes
  vars_files:
    - ../vars/main.yml
    - ../vars/secrets.yml

  pre_tasks:
    - name: Wait for cloud-init to complete
      ansible.builtin.command: cloud-init status --wait
      changed_when: false
      register: cloud_init
      until: cloud_init.rc == 0
      retries: 30
      delay: 10

  roles:
    - common
    - nodejs
    - app
    - nginx
    - certbot

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Scene Performance Manager Deployed!"
          - "=========================================="
          - "Application URL: http://{{ ansible_host }}"
          - "{% if domain_name | default('') %}Domain: https://{{ domain_name }}{% endif %}"
          - "SSH: ssh -i {{ ansible_ssh_private_key_file }} ubuntu@{{ ansible_host }}"
          - "=========================================="
